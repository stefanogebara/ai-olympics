# Docker Compose for AI Olympics Agent Sandboxes
# Security: no SYS_ADMIN, read-only rootfs, Chrome runs with --no-sandbox
# (Docker itself provides the sandbox isolation)

version: '3.8'

x-sandbox-defaults: &sandbox-defaults
  build:
    context: ../..
    dockerfile: infrastructure/docker/Dockerfile.agent
  deploy:
    resources:
      limits:
        cpus: '2'
        memory: 4G
  # Security hardening: drop all capabilities, no privilege escalation
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL
  # No SYS_ADMIN â€” Chrome uses --no-sandbox; Docker is the sandbox
  read_only: true
  tmpfs:
    - /tmp:rw,noexec,nosuid,size=256m
  networks:
    - ai-olympics
  dns:
    - 8.8.8.8
    - 8.8.4.4

services:
  # Claude Agent Sandbox
  sandbox-claude:
    <<: *sandbox-defaults
    container_name: sandbox-claude
    environment:
      - AGENT_ID=claude-opus
      - AGENT_PROVIDER=claude
      - HEADLESS=false
      - VIEWPORT_WIDTH=1920
      - VIEWPORT_HEIGHT=1080
      - CHROME_FLAGS=--no-sandbox --disable-setuid-sandbox --disable-dev-shm-usage
    ports:
      - "9222:9222"

  # GPT-4 Agent Sandbox
  sandbox-gpt4:
    <<: *sandbox-defaults
    container_name: sandbox-gpt4
    environment:
      - AGENT_ID=gpt-4o
      - AGENT_PROVIDER=openai
      - HEADLESS=false
      - VIEWPORT_WIDTH=1920
      - VIEWPORT_HEIGHT=1080
      - CHROME_FLAGS=--no-sandbox --disable-setuid-sandbox --disable-dev-shm-usage
    ports:
      - "9223:9222"

  # Gemini Agent Sandbox
  sandbox-gemini:
    <<: *sandbox-defaults
    container_name: sandbox-gemini
    environment:
      - AGENT_ID=gemini-pro
      - AGENT_PROVIDER=gemini
      - HEADLESS=false
      - VIEWPORT_WIDTH=1920
      - VIEWPORT_HEIGHT=1080
      - CHROME_FLAGS=--no-sandbox --disable-setuid-sandbox --disable-dev-shm-usage
    ports:
      - "9224:9222"

networks:
  ai-olympics:
    driver: bridge
    internal: false
    driver_opts:
      # Block access to host network's private ranges from containers
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.bridge.enable_icc: "false"

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Olympics - Cipher Break Challenge</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      padding: 30px;
      color: #fff;
    }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { font-size: 2.2rem; background: linear-gradient(90deg, #00d4ff, #7c3aed, #ff6b6b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
    .timer { position: fixed; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.6); padding: 15px 25px; border-radius: 10px; font-family: monospace; font-size: 1.5rem; color: #00d4ff; z-index: 100; }
    .timer.warning { color: #ff6b6b; animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .progress-bar { max-width: 600px; margin: 0 auto 30px; background: rgba(255, 255, 255, 0.1); height: 10px; border-radius: 5px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #7c3aed, #00d4ff); transition: width 0.3s; }
    .stats-bar { display: flex; justify-content: center; gap: 30px; margin-bottom: 20px; }
    .stat { text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: bold; color: #00d4ff; }
    .stat-label { font-size: 0.8rem; color: #a0aec0; }
    .problem-container { max-width: 600px; margin: 0 auto; }
    .problem-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 30px; margin-bottom: 20px; }
    .problem-number { color: #7c3aed; font-size: 0.9rem; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .difficulty-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
    .difficulty-easy { background: rgba(72, 187, 120, 0.2); color: #48bb78; }
    .difficulty-medium { background: rgba(237, 137, 54, 0.2); color: #ed8936; }
    .difficulty-hard { background: rgba(252, 129, 129, 0.2); color: #fc8181; }
    .problem-text { color: #e2e8f0; line-height: 1.6; font-size: 1.4rem; text-align: center; margin: 30px 0; font-family: 'Courier New', Courier, monospace; }
    .cipher-hint { color: #a0aec0; font-size: 0.9rem; text-align: center; margin-bottom: 20px; font-style: italic; }
    .input-group { display: flex; gap: 10px; }
    .answer-input { flex: 1; padding: 14px; background: rgba(255, 255, 255, 0.08); border: 2px solid rgba(255, 255, 255, 0.15); border-radius: 10px; color: white; font-size: 1.2rem; text-align: center; font-family: 'Courier New', Courier, monospace; text-transform: uppercase; }
    .answer-input:focus { outline: none; border-color: #7c3aed; }
    .submit-btn { padding: 14px 30px; background: linear-gradient(90deg, #7c3aed, #00d4ff); border: none; border-radius: 10px; color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
    .submit-btn:hover { opacity: 0.9; }
    .submit-btn:disabled { background: #4a5568; cursor: not-allowed; }
    .feedback { margin-top: 15px; padding: 12px; border-radius: 8px; text-align: center; font-weight: 500; }
    .feedback.correct { background: rgba(72, 187, 120, 0.2); color: #48bb78; }
    .feedback.incorrect { background: rgba(252, 129, 129, 0.2); color: #fc8181; }
    .hidden { display: none; }
    .loading { text-align: center; padding: 50px; }
    .loading-spinner { width: 50px; height: 50px; border: 4px solid rgba(255, 255, 255, 0.1); border-top-color: #7c3aed; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .success-screen { text-align: center; padding: 40px; max-width: 600px; margin: 0 auto; }
    .success-icon { font-size: 4rem; margin-bottom: 20px; }
    .success-screen h2 { color: #48bb78; font-size: 2rem; margin-bottom: 15px; }
    .score-display { font-size: 3rem; font-weight: bold; color: #00d4ff; margin: 20px 0; }
    .results-summary { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 25px 0; }
    .result-item { background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; }
    .result-item-value { font-size: 1.5rem; font-weight: bold; color: #00d4ff; }
    .result-item-label { font-size: 0.85rem; color: #a0aec0; }
    .results-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px; }
    .result-box { padding: 15px 10px; border-radius: 8px; text-align: center; }
    .result-box.correct { background: rgba(72, 187, 120, 0.2); color: #48bb78; }
    .result-box.incorrect { background: rgba(252, 129, 129, 0.2); color: #fc8181; }
  </style>
</head>
<body>
  <div class="timer" id="timer">120</div>

  <div class="header">
    <h1>Cipher Break Challenge</h1>
    <p style="color: #a0aec0;">Decode encrypted messages - crack the code!</p>
  </div>

  <div class="progress-bar">
    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
  </div>

  <div class="stats-bar">
    <div class="stat">
      <div class="stat-value" id="scoreDisplay">0</div>
      <div class="stat-label">Score</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="correctDisplay">0</div>
      <div class="stat-label">Correct</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="problemNum">1/10</div>
      <div class="stat-label">Problem</div>
    </div>
  </div>

  <div class="loading" id="loadingScreen">
    <div class="loading-spinner"></div>
    <p>Preparing cipher puzzles...</p>
  </div>

  <div class="problem-container hidden" id="problemContainer"></div>

  <div class="success-screen hidden" id="successScreen">
    <div class="success-icon">CODEBREAKER</div>
    <h2>Challenge Complete!</h2>
    <div class="score-display">Score: <span id="finalScore">0</span>/1000</div>
    <div class="results-summary">
      <div class="result-item">
        <div class="result-item-value" id="finalCorrect">0</div>
        <div class="result-item-label">Correct Answers</div>
      </div>
      <div class="result-item">
        <div class="result-item-value" id="finalTime">0s</div>
        <div class="result-item-label">Total Time</div>
      </div>
      <div class="result-item">
        <div class="result-item-value" id="timeBonus">0</div>
        <div class="result-item-label">Time Bonus</div>
      </div>
      <div class="result-item">
        <div class="result-item-value" id="accuracy">0%</div>
        <div class="result-item-label">Accuracy</div>
      </div>
    </div>
    <div class="results-grid" id="resultsGrid"></div>
  </div>

  <script>
    // State
    var problems = [];
    var currentProblem = 0;
    var answers = [];
    var score = 0;
    var correctCount = 0;
    var startTime = Date.now();
    var problemStartTime = Date.now();
    var problemTimer = null;
    var problemTimeLeft = 120;

    // DOM Elements
    var timerEl = document.getElementById('timer');
    var progressFill = document.getElementById('progressFill');
    var loadingScreen = document.getElementById('loadingScreen');
    var problemContainer = document.getElementById('problemContainer');
    var successScreen = document.getElementById('successScreen');
    var scoreDisplay = document.getElementById('scoreDisplay');
    var correctDisplay = document.getElementById('correctDisplay');
    var problemNum = document.getElementById('problemNum');

    // Hardcoded fallback problems
    function getDefaultProblems() {
      return [
        // Easy (Caesar with known shift)
        {
          encrypted: 'KHOOR ZRUOG',
          hint: 'Caesar cipher, shift +3',
          answer: 'HELLO WORLD',
          difficulty: 'easy'
        },
        {
          encrypted: 'IFMMP',
          hint: 'Caesar cipher, shift +1',
          answer: 'HELLO',
          difficulty: 'easy'
        },
        {
          encrypted: 'YMJWJ',
          hint: 'Caesar cipher, shift +5',
          answer: 'THERE',
          difficulty: 'easy'
        },
        // Medium (Caesar unknown shift or reverse)
        {
          encrypted: 'LIPPS ASVPH',
          hint: 'Caesar cipher, unknown shift',
          answer: 'HELLO WORLD',
          difficulty: 'medium'
        },
        {
          encrypted: 'DLROW OLLEH',
          hint: 'Reversed text',
          answer: 'HELLO WORLD',
          difficulty: 'medium'
        },
        {
          encrypted: 'URYYB JBEYQ',
          hint: 'ROT13 cipher',
          answer: 'HELLO WORLD',
          difficulty: 'medium'
        },
        {
          encrypted: 'BZDRZQ',
          hint: 'Caesar cipher, unknown shift',
          answer: 'CAESAR',
          difficulty: 'medium'
        },
        // Hard (substitution/mixed)
        {
          encrypted: '8-5-12-12-15',
          hint: 'A=1, B=2, ... Z=26',
          answer: 'HELLO',
          difficulty: 'hard'
        },
        {
          encrypted: 'SVOOL',
          hint: 'Atbash cipher (A<->Z, B<->Y...)',
          answer: 'HELLO',
          difficulty: 'hard'
        },
        {
          encrypted: 'IDMKP VPQMC',
          hint: 'Alternating +1/-1 shift pattern',
          answer: 'HELLO WORLD',
          difficulty: 'hard'
        }
      ];
    }

    // Normalize answer for comparison: uppercase, trim, collapse spaces
    function normalizeAnswer(str) {
      return str.toUpperCase().trim().replace(/\s+/g, ' ');
    }

    // Check if user answer matches expected answer
    function checkAnswer(userAnswer, expectedAnswer) {
      var normalizedUser = normalizeAnswer(userAnswer);
      var normalizedExpected = normalizeAnswer(expectedAnswer);

      // Exact match
      if (normalizedUser === normalizedExpected) return true;

      // Match without spaces (accept "HELLOWORLD" for "HELLO WORLD")
      var userNoSpaces = normalizedUser.replace(/\s/g, '');
      var expectedNoSpaces = normalizedExpected.replace(/\s/g, '');
      if (userNoSpaces === expectedNoSpaces) return true;

      return false;
    }

    // Load problems
    async function loadProblems() {
      try {
        var response = await fetch('/api/games/cipher/puzzle');
        if (!response.ok) throw new Error('API error');
        var data = await response.json();
        problems = data.problems || data;
        if (!problems.length) throw new Error('No problems');
      } catch (error) {
        console.log('Using fallback cipher problems:', error.message);
        problems = getDefaultProblems();
      }

      loadingScreen.classList.add('hidden');
      problemContainer.classList.remove('hidden');
      renderProblem(0);
      startProblemTimer();
    }

    function startProblemTimer() {
      problemTimeLeft = 120;
      problemStartTime = Date.now();
      updateTimerDisplay();

      if (problemTimer) clearInterval(problemTimer);
      problemTimer = setInterval(function() {
        problemTimeLeft--;
        updateTimerDisplay();

        if (problemTimeLeft <= 0) {
          clearInterval(problemTimer);
          handleTimeout();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      timerEl.textContent = problemTimeLeft;
      if (problemTimeLeft <= 30) {
        timerEl.classList.add('warning');
      } else {
        timerEl.classList.remove('warning');
      }
    }

    function handleTimeout() {
      answers.push({
        problemIndex: currentProblem,
        userAnswer: null,
        correct: false,
        timeSpent: 120000
      });

      showFeedback(false, problems[currentProblem].answer);

      setTimeout(function() {
        nextProblem();
      }, 1500);
    }

    function renderProblem(index) {
      var p = problems[index];
      progressFill.style.width = ((index / problems.length) * 100) + '%';
      problemNum.textContent = (index + 1) + '/' + problems.length;

      // Clear container safely
      while (problemContainer.firstChild) {
        problemContainer.removeChild(problemContainer.firstChild);
      }

      var card = document.createElement('div');
      card.className = 'problem-card';

      // Problem header
      var numDiv = document.createElement('div');
      numDiv.className = 'problem-number';

      var problemLabel = document.createElement('span');
      problemLabel.textContent = 'Problem ' + (index + 1) + ' of ' + problems.length;

      var diffBadge = document.createElement('span');
      diffBadge.className = 'difficulty-badge difficulty-' + p.difficulty;
      diffBadge.textContent = p.difficulty.charAt(0).toUpperCase() + p.difficulty.slice(1);

      numDiv.appendChild(problemLabel);
      numDiv.appendChild(diffBadge);

      // Encrypted text display
      var textDiv = document.createElement('div');
      textDiv.className = 'problem-text';
      textDiv.textContent = p.encrypted;

      // Cipher type hint
      var hintDiv = document.createElement('div');
      hintDiv.className = 'cipher-hint';
      hintDiv.textContent = 'Hint: ' + p.hint;

      // Input group
      var inputGroup = document.createElement('div');
      inputGroup.className = 'input-group';

      var input = document.createElement('input');
      input.type = 'text';
      input.className = 'answer-input';
      input.id = 'answerInput';
      input.placeholder = 'Decoded message';
      input.setAttribute('aria-label', 'Enter the decoded message');
      input.setAttribute('autocomplete', 'off');
      input.setAttribute('spellcheck', 'false');

      var submitBtn = document.createElement('button');
      submitBtn.className = 'submit-btn';
      submitBtn.id = 'submitBtn';
      submitBtn.textContent = 'Submit';

      inputGroup.appendChild(input);
      inputGroup.appendChild(submitBtn);

      // Feedback area
      var feedbackDiv = document.createElement('div');
      feedbackDiv.className = 'feedback hidden';
      feedbackDiv.id = 'feedback';

      card.appendChild(numDiv);
      card.appendChild(textDiv);
      card.appendChild(hintDiv);
      card.appendChild(inputGroup);
      card.appendChild(feedbackDiv);
      problemContainer.appendChild(card);

      // Event listeners
      submitBtn.onclick = submitAnswer;
      input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') submitAnswer();
      });

      input.focus();
    }

    function submitAnswer() {
      var input = document.getElementById('answerInput');
      var userAnswer = input.value.trim();

      if (!userAnswer) {
        input.style.borderColor = '#fc8181';
        return;
      }

      clearInterval(problemTimer);

      var timeSpent = Date.now() - problemStartTime;
      var p = problems[currentProblem];
      var isCorrect = checkAnswer(userAnswer, p.answer);

      // Calculate points
      var points = 0;
      if (isCorrect) {
        points = 100; // Base points per correct answer
        // Time bonus multiplier
        var timeMultiplier = Math.max(1, 2 - (timeSpent / 120000));
        points = Math.floor(points * timeMultiplier);
        score += points;
        correctCount++;
      }

      answers.push({
        problemIndex: currentProblem,
        userAnswer: userAnswer,
        correct: isCorrect,
        timeSpent: timeSpent,
        points: points
      });

      // Update displays
      scoreDisplay.textContent = score;
      correctDisplay.textContent = correctCount;

      // Show feedback
      showFeedback(isCorrect, p.answer);

      // Disable input and button
      input.disabled = true;
      document.getElementById('submitBtn').disabled = true;

      setTimeout(function() {
        nextProblem();
      }, 1500);
    }

    function showFeedback(isCorrect, correctAnswer) {
      var feedback = document.getElementById('feedback');
      feedback.classList.remove('hidden', 'correct', 'incorrect');
      feedback.classList.add(isCorrect ? 'correct' : 'incorrect');
      feedback.textContent = isCorrect ? 'Correct!' : 'Incorrect. The answer was: ' + correctAnswer;
    }

    function nextProblem() {
      if (currentProblem < problems.length - 1) {
        currentProblem++;
        renderProblem(currentProblem);
        startProblemTimer();
      } else {
        showResults();
      }
    }

    function showResults() {
      clearInterval(problemTimer);
      var totalTime = (Date.now() - startTime) / 1000;

      // Cap score at 1000
      var finalScore = Math.min(1000, score);

      problemContainer.classList.add('hidden');
      progressFill.style.width = '100%';
      successScreen.classList.remove('hidden');
      timerEl.classList.add('hidden');

      document.getElementById('finalScore').textContent = finalScore;
      document.getElementById('finalCorrect').textContent = correctCount + '/' + problems.length;
      document.getElementById('finalTime').textContent = totalTime.toFixed(1) + 's';
      document.getElementById('timeBonus').textContent = '+' + Math.max(0, finalScore - (correctCount * 100));
      document.getElementById('accuracy').textContent = Math.round((correctCount / problems.length) * 100) + '%';

      var resultsGrid = document.getElementById('resultsGrid');
      while (resultsGrid.firstChild) {
        resultsGrid.removeChild(resultsGrid.firstChild);
      }

      answers.forEach(function(answer, i) {
        var box = document.createElement('div');
        box.className = 'result-box ' + (answer.correct ? 'correct' : 'incorrect');

        var pLabel = document.createElement('div');
        pLabel.textContent = 'P' + (i + 1);

        var result = document.createElement('div');
        result.textContent = answer.correct ? 'OK' : 'X';

        box.appendChild(pLabel);
        box.appendChild(result);
        resultsGrid.appendChild(box);
      });

      // Notify parent window
      var completionTime = totalTime;
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({
          type: 'GAME_COMPLETE',
          data: {
            score: finalScore,
            correctCount: correctCount,
            totalQuestions: 10,
            completionTime: completionTime,
            answers: answers
          }
        }, window.location.origin);
      }
    }

    // Start
    loadProblems();
  </script>
</body>
</html>
